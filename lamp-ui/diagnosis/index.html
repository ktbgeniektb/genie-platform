<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="./../css/diagnosis.css" />

    <title>診断</title>
  </head>
  <body>
    <section
      class="bg layer1"
      data-bg="./../img/layer1.jpg"
      data-bg-sp="./../img/layer1_sp.jpg"
    >
      <div
        class="question"
        data-index="0"
        data-main="kyomei"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>1. 自分は、誰かの言葉や行動に強く心を動かされることがある</p>
        <div class="choices"></div>
        <div
          id="error-q0"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="1"
        data-main="tankyu"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>2. 「なぜそうなるのか」を知りたくなることが多い</p>
        <div class="choices"></div>
        <div
          id="error-q1"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="2"
        data-main="hyougen"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>3. 自分のアイデアや想いを言葉や形にして誰かに伝えるのが好きだ</p>
        <div class="choices"></div>
        <div
          id="error-q2"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="3"
        data-main="taiken"
        data-sub="hyougen"
        data-weight-main="1.5"
        data-weight-sub="0.3"
      >
        <p>
          4.
          周りが盛り上がっていると、自分もつい手を挙げたり声を出したりしてしまう
        </p>
        <div class="choices"></div>
        <div
          id="error-q3"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="4"
        data-main="chosen"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>
          5.
          未知のことに出会うと、失敗より「まずやってみたい」という気持ちが先にくる
        </p>
        <div class="choices"></div>
        <div
          id="error-q4"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="5"
        data-main="kyomei"
        data-sub="tankyu"
        data-weight-main="1.5"
        data-weight-sub="0.3"
      >
        <p>
          6.
          心が動かされたとき、“なんでそう思ったんだろう”と自分に問いかけることがある
        </p>
        <div class="choices"></div>
        <div
          id="error-q5"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="6"
        data-main="taiken"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>
          7.
          自分は、ネットで見た情報よりも「実物を見て感じたこと」を信じるタイプだ
        </p>
        <div class="choices"></div>
        <div
          id="error-q6"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>
    </section>
    <section
      class="bg layer2"
      data-bg="./../img/layer2.jpg"
      data-bg-sp="./../img/layer2_sp.jpg"
    >
      <div
        class="question"
        data-index="7"
        data-main="kyomei"
        data-sub="taiken"
        data-weight-main="1.5"
        data-weight-sub="0.3"
      >
        <p>
          8.
          人の「空気感」や「感情」にすぐ気づくことがある（例：声のトーン、顔色、間）
        </p>
        <div class="choices"></div>
        <div
          id="error-q7"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="8"
        data-main="tankyu"
        data-sub="hyougen"
        data-weight-main="1.5"
        data-weight-sub="1.0"
      >
        <p>9. 調べたことを、“どうやったら伝わるか”まで考えたくなることがある</p>
        <div class="choices"></div>
        <div
          id="error-q8"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="9"
        data-main="chosen"
        data-sub="tankyu"
        data-weight-main="1.5"
        data-weight-sub="0.6"
      >
        <p>10. やってみて“うまくいかない理由”を探すのが面白いと感じる</p>
        <div class="choices"></div>
        <div
          id="error-q9"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="10"
        data-main="kyomei"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>11. 誰かの熱い想いを聞くと、自分も心を動かされる</p>
        <div class="choices"></div>
        <div
          id="error-q10"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="11"
        data-main="hyougen"
        data-sub="tankyu"
        data-weight-main="1.5"
        data-weight-sub="1.2"
      >
        <p>12. 自分の伝えたいことを「どう伝えたら伝わるか」考えるのが好きだ</p>
        <div class="choices"></div>
        <div
          id="error-q11"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="12"
        data-main="chosen"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>
          13. 新しいことを見つけると、“うまくできるか”より“面白そう”が先に来る
        </p>
        <div class="choices"></div>
        <div
          id="error-q12"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="13"
        data-main="chosen"
        data-sub="kyomei"
        data-weight-main="1.5"
        data-weight-sub="0.3"
      >
        <p>
          14. 誰かの“本気の想い”を聞くと、自分も“やってみたくなる”ことがある
        </p>
        <div class="choices"></div>
        <div
          id="error-q13"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="14"
        data-main="tankyu"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>15. とことん調べたり、知識を深めることが好き</p>
        <div class="choices"></div>
        <div
          id="error-q14"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>
    </section>
    <section
      class="bg layer3"
      data-bg="./../img/layer3.jpg"
      data-bg-sp="./../img/layer3_sp.jpg"
    >
      <div
        class="question"
        data-index="15"
        data-main="tankyu"
        data-sub="taiken"
        data-weight-main="1.5"
        data-weight-sub="1.0"
      >
        <p>16. 体験したことの“理由”や“背景”を知ると、より深く面白く感じる</p>
        <div class="choices"></div>
        <div
          id="error-q15"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="16"
        data-main="hyougen"
        data-sub="chosen"
        data-weight-main="1.5"
        data-weight-sub="0.3"
      >
        <p>
          17. 自分にしかできない伝え方や言葉遣いを、試してみたくなることがある
        </p>
        <div class="choices"></div>
        <div
          id="error-q16"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="17"
        data-main="hyougen"
        data-sub="kyomei"
        data-weight-main="1.5"
        data-weight-sub="0.6"
      >
        <p>18. 感情が乗った表現を見ると、なぜか涙が出たり鳥肌が立つ</p>
        <div class="choices"></div>
        <div
          id="error-q17"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="18"
        data-main="taiken"
        data-sub="kyomei"
        data-weight-main="1.5"
        data-weight-sub="1.0"
      >
        <p>19. ライブや舞台、イベントの空気感で心が揺さぶられることがある</p>
        <div class="choices"></div>
        <div
          id="error-q18"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="19"
        data-main="taiken"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>20. 実際に“やってみて”初めて分かることが多い</p>
        <div class="choices"></div>
        <div
          id="error-q19"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="20"
        data-main="kyomei"
        data-sub="chosen"
        data-weight-main="1.5"
        data-weight-sub="1.2"
      >
        <p>21. 共感した相手のために、自分も動きたくなることがある</p>
        <div class="choices"></div>
        <div
          id="error-q20"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="21"
        data-main="taiken"
        data-sub="chosen"
        data-weight-main="1.5"
        data-weight-sub="0.6"
      >
        <p>22. 初めての場所や体験にワクワクすることが多い</p>
        <div class="choices"></div>
        <div
          id="error-q21"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>
    </section>
    <section
      class="bg layer4"
      data-bg="./../img/layer4.jpg"
      data-bg-sp="./../img/layer4_sp.jpg"
    >
      <div
        class="question"
        data-index="22"
        data-main="chosen"
        data-sub="hyougen"
        data-weight-main="1.5"
        data-weight-sub="0.6"
      >
        <p>23. 自信がなくても、“伝えてみる”ことに価値があると感じる</p>
        <div class="choices"></div>
        <div
          id="error-q22"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="23"
        data-main="tankyu"
        data-sub="chosen"
        data-weight-main="1.5"
        data-weight-sub="1.0"
      >
        <p>24. わからないことをそのままにしておくのが気持ち悪い</p>
        <div class="choices"></div>
        <div
          id="error-q23"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="24"
        data-main="kyomei"
        data-sub="hyougen"
        data-weight-main="1.5"
        data-weight-sub="1.2"
      >
        <p>25. 感動したとき、それを“誰かに伝えたい”という気持ちが湧く</p>
        <div class="choices"></div>
        <div
          id="error-q24"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="25"
        data-main="hyougen"
        data-sub="core"
        data-weight-main="2.0"
        data-weight-sub="0.0"
      >
        <p>26. 感動したことを“自分の言葉”で誰かに伝えたくなることがある</p>
        <div class="choices"></div>
        <div
          id="error-q25"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="26"
        data-main="chosen"
        data-sub="taiken"
        data-weight-main="1.5"
        data-weight-sub="1.2"
      >
        <p>27. 新しいことに挑戦して、“実際に感じる”ことに価値があると思う</p>
        <div class="choices"></div>
        <div
          id="error-q26"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="27"
        data-main="tankyu"
        data-sub="kyomei"
        data-weight-main="1.5"
        data-weight-sub="1.2"
      >
        <p>28. 人の行動や選択の“背景”をつい考えてしまう</p>
        <div class="choices"></div>
        <div
          id="error-q27"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="28"
        data-main="taiken"
        data-sub="tankyu"
        data-weight-main="1.5"
        data-weight-sub="1.0"
      >
        <p>29. 体で感じたことをもとに考えたり判断したりする方が得意だ</p>
        <div class="choices"></div>
        <div
          id="error-q28"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <div
        class="question"
        data-index="29"
        data-main="hyougen"
        data-sub="taiken"
        data-weight-main="1.5"
        data-weight-sub="0.6"
      >
        <p>
          30. 印象に残る体験をしたとき、それを“どう伝えるか”をつい考えてしまう
        </p>
        <div class="choices"></div>
        <div
          id="error-q29"
          class="error"
          style="color: red; display: none"
        ></div>
      </div>

      <button id="end-diagnosis" type="button">Lampを探しに行く</button>
    </section>
    <script>
      const choices = [
        "まったくそう思わない",
        "あまりそう思わない",
        "どちらでもない",
        "ややそう思う",
        "とてもそう思う",
      ];

      function showError(selector, message) {
        $(selector).text(message).show();
      }

      function clearError(selector) {
        $(selector).text("").hide();
      }

      $(".question").each(function () {
        const index = $(this).data("index");
        const $choices = $(this).find(".choices");

        choices
          .slice()
          .reverse()
          .forEach((label, i) => {
            // <label><input type="radio" name="q0" value="1"> まったくそう思わない</label><br/>　の生成
            const score = choices.length - i; // 最大が5になる
            const $label = $(
              `<label><input type="radio" name="q${index}" value="${score}"> ${label}</label><br/>`
            );
            $choices.append($label);
          });
      });
    </script>

    <script type="module">
      import { saveDiagnosis } from "./../js/save.js";

      $("#end-diagnosis").on("click", function () {
        let isValid = true;

        $(".question").each(function () {
          const index = $(this).data("index");
          const selected = $(`input[name="q${index}"]:checked`);
          const $error = $(`#error-q${index}`);

          if (selected.length === 0) {
            $error.text("この質問に回答してください").show();
            if (isValid) {
              // 最初の未回答エラーにスクロール
              $("html, body").animate(
                { scrollTop: $(this).offset().top - 100 },
                500
              );
            }
            isValid = false;
          } else {
            $error.hide();
          }
        });

        if (isValid == true) {
          let scores = {
            kyomei: 0,
            tankyu: 0,
            hyougen: 0,
            taiken: 0,
            chosen: 0,
          };

          $(".question").each(function () {
            const index = $(this).data("index");
            const main = $(this).data("main");
            const sub = $(this).data("sub");
            const weightMain = parseFloat($(this).data("weight-main"));
            const weightSub = parseFloat($(this).data("weight-sub"));
            const value = parseInt($(`input[name="q${index}"]:checked`).val());

            scores[main] += value * weightMain;

            if (sub !== "core") {
              scores[sub] += value * weightSub;
            }
          });

          const typeMap = {
            kyomei: "共鳴型",
            tankyu: "探究型",
            hyougen: "表現型",
            taiken: "体験型",
            chosen: "挑戦型",
          };

          //ここはGPTに頼った、中身理解必要
          const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
          const top1 = sorted[0][0];
          const top2 = sorted[1][0];

          localStorage.setItem("top1", typeMap[top1]);
          localStorage.setItem("top2", typeMap[top2]);

          Object.entries(scores).forEach(([label, score]) => {
            const key = typeMap[label];
            localStorage.setItem(key, score);
          });
          // Firestoreに保存（今回追加）
          const scoreData = {
            kyomei: scores["kyomei"],
            tankyu: scores["tankyu"],
            hyougen: scores["hyougen"],
            taiken: scores["taiken"],
            chosen: scores["chosen"],
          };
          const topType = `${top1}_${top2}`;
          saveDiagnosis(scoreData, topType);
        }
      });
    </script>
  </body>
</html>
